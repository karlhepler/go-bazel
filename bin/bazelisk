#!/usr/bin/env sh

set -e
[ "$DEBUG" = true ] && set -x

release='v1.11.0'

# validate supported operating systems
case "$(uname -sm)" in
    'Darwin x86_64') platform='darwin-amd64';;
    'Darwin arm64') platform='darwin-arm64';;
    'Linux x86_64') platform='linux-amd64';;
    *) >&2 echo 'unsupported operating system'; exit 1;;
esac

# maybe download bazelisk
bazelisk="bazelisk-$platform-$release"
if [ ! -f "$CACHE_BIN/$bazelisk" ]; then
    (
        cd "$CACHE_BIN"
        curl -Lo "$bazelisk" "https://github.com/bazelbuild/bazelisk/releases/download/$release/bazelisk-$platform"
        chmod +x "$bazelisk"
    )
fi

# maybe create generated bazelrc
if [ ! -f "$REPO_ROOT/.bazelrc.generated" ]; then
cat << EOF > "$REPO_ROOT/.bazelrc.generated"
# Code generated by $REPO_ROOT/bin/bazelisk DO NOT EDIT
startup --output_user_root=$CACHE/bazel
build --disk_cache=$CACHE/bazel_disk_cache
common --repository_cache=$CACHE/bazel_repository_cache
EOF
fi

exec "$CACHE_BIN/$bazelisk" \
    --bazelrc="$REPO_ROOT/.bazelrc.generated" \
    --bazelrc="$REPO_ROOT/.bazelrc" \
    "$@"
